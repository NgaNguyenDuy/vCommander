#!/usr/bin/env node

var program = require('commander'),
    mkdirp = require('mkdirp'),
    fs = require('fs'),
    path = require('path'),
    pkg = require('../package.json'),
    readline = require('readline'),
    version = pkg.version;

// var rl = readline.createInterface({
//     input: process.stdin,
//     output: process.stdout
// });



program
    .version(version)
    .usage('[options] [dir]')
    .option('-d, --database <database type>', 'Using mongodb for project (default to mongodb)')
    .option('    --force', 'force create server on non-empty server');

program.on('--help', function() {
    console.log('  Example: ');
    console.log('');
    console.log('     $ vsoft createServer');
    console.log('     $ vsoft -d redis socialApp');
    console.log('     $ vsoft -d elasticsearch eTimes');
    console.log('');
});
//    .option('-c, --cheese [type]', 'Add the specified type of cheese [marble]', 'marble')
program.parse(process.argv);

// console.log('  - %s cheese', program.cheese);


var despath = program.args.shift() || '.';


var app_name = path.basename(path.resolve(despath));


program.db = 'mongodb';

if(program.database === 'redis') program.db ='redis';

if(program.database === 'elasticsearch') program.db = 'elasticsearch';


(function createApp(path) {
    emptyDir(path, function(empty) {
        if(empty || program.force) {
            createServerAt(path);
        } else {
            abort('Aborting');
            // program.confirm('des not empty', function(ok) {
            //     if(ok) {
            //         process.stdin.destroy();
            //         createServerAt(path);
                    
            //     } else {
            //         abort('Aborting');
            //     }
            // });
        }
    });
})(despath);

function createServerAt(path) {
    console.log();
    process.on('exit', function() {
        console.log();
        console.log('    To install dependencies:');
        console.log('      $ cd %s && npm install', path);
        console.log();
        console.log('    Run the app: ');
        console.log('      $ DEBUG=' + app_name + ' npm start');
        console.log();
    });
    
    mkdir(path, function() {
        write(path + '/package.json', JSON.stringify(pkgj, null, 2));
        write(path + '/config.json', JSON.stringify(cfg, null, 2));
        mkdir(path + '/boot');
        mkdir(path + '/controller');
        mkdir(path + '/models');
    });
    

    // console.log('create server at ' + path + ' and using ' + program.db.main);
};


var pkgj = {
    name : app_name,
    version: '0.0.1',
    private: true,
    scripts: {
        start: 'node server.js'
    },
    dependencies: {
        'express' : '~4.9.0'
    }
};

var cfg = {
    host: 'localhost',
    port: process.env.PORT || 9009
};


function mkdir(path, fn) {
    mkdirp(path, 0755, function(err) {
        if(err) throw err;
        console.log(' \033[36mcreate\033[0m : ' + path);
        fn && fn();
    });
}

function write(path, str, mode) {
    fs.writeFile(path, str, {mode: mode || 0666});
    console.log(' \x1b[36mcreate\x1b[0m : ' + path);
}

function emptyDir(path, fn) {
    fs.readdir(path, function(err, file) {
        if(err && 'ENOENT' != err.code) throw err;
        fn(!file || !file.length);
    });
};



// rl.question("What do you think of node.js? ", function(answer) {
//   // TODO: Log the answer in a database
//   console.log("Thank you for your valuable feedback:", answer);

//   rl.close();
// });


// function promptMultiLine(str, fn) {
//     var buf = [];
//     console.log(str);
//     process.stdin.setEncoding('utf8');
//     process.stdin.on('data', function(val) {
//         if('\n' == val || '\r\n' == val) {
//             fn(buf.join('\n'));
//         } else {
//             buf.push(val);
//         }
//     }).resume();
// }

// promptMultiLine('hehe', function(data) {
//     console.log(data);
// });

// function prompt (str, fn) {

// }

// function confirm(str, fn) {
//     // rl.question(str, function(answer) {
        
//     // }) ;
// };

function abort(str) {
    console.error(str);
    process.exit(1);
}
